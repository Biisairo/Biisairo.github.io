# 4. 프로그램의 구조와 실행

## 1. 프로그램의 구조와 인터럽트

- 프로그램의 메모리
    - 코드
        - 우리가 작성한 함수들의 코드가 기계어 명령(machine instruction) 형태로 변환되어 저장되는 부분
    - 데이터
        - 전역 변수(global variable) 같은 프로그램이 사용하는 데이터를 저장하는 부분
    - 스택
        - 함수가 호출될 때 함수의 수행을 끝내고 돌아올 주소를 저장하는 부분
        - 데이터 저장

## 2. 컴퓨터 시스템의 작동 개요

- 프로그램 카운터 (program counter : PC)
    - CPU 가 수행해야 할 메모리의 주소를 담고있는 레지스터
    - 매번 PC 가 담고있는 메모리 주소의 명령을 실행

## 3. 프로그램의 실행

- 프로그램이 실행 되고 있다
    - 디스크에 존재하던 실행 파일이 메모리에 적재되었다
    - 프로그램이 cpu 를 할당 받고 명령을 수행중이다
- 프로그램의 주소 공간
    - 코드, 데이터, 스택
    - 각각의 프로그램마다 독자적인 주소공간을 별도로 보유
        - 가상메모리(virtual memory), 논리적 메모리(logical memory)
    - 운영체제 또한 하나의 프로그램으로서 독자적인 코드, 데이터, 스택 공간을 가진다
- 커널
    - 커널의 데이터 영역
        - 각종 자원을 관리하기 위한 자료구조들이 존재
        - CPU 나 하드웨어 자원을 관리하기 위한 자료구조
        - 현재 수행중이 프로그램을 관리하기 위한 자료구조
        - PCB
            - 각 프로세스의 상태, cpu 의 사용정보, 메모리 사용 정보들을 유지하기 위한 자료구조
    - 커널의 스택 영역
        - 일반 프로그램과 같이 함수 호출시의 복귀 주소를 저장하기 위한 용도
        - 현재 사용중인 프로세스 마다 개별적으로 스택을 두어 관리
            - 프로세스가 시스템 콜을 호출하고 시스템 콜이 다른 함수를 호출했을 때 복귀주소가 프로그램 스택이 아닌 커널내부의 스택으로 가게됨
            - 각각 프로세스별로 스택을 두어 이를 관리
            - 프로그램이 스스로의 코드 내에서 함수를 호출하면 프로그램의 스택을 사용
            - 시스템 콜, 인터럽트로 운영체제의 코드가 실행되면 커널의 스택을 사용

## 4. 사용자 프로그램이 사용하는 함수

- 사용자 정의 함수
    - 프로그래머 본인이 직접 짠 함수
- 라이브러리 함수
    - 누군가가 작성해서 라이브러리로 만들어 둔 함수
- 커널 함수
    - 커널의 코드에 정의된 함수
    - 시스템콜, 인터럽트 등
    - 운영체제 커널의 주소공간에 정의되어 있음
    - 운영체제 내부에 있는 함수를 사용자가 호출하여 사용하는 것

## 5. 인터럽트

- CPU 는 매번 한줄의 명령을 수행한 뒤 다름 명령을 수행하기 전 인터럽트 라인을 확인
- 인터럽트가 발생하면 프로세스를 멈추고 인터럽트를 처리함
- 인터럽트 처리가 끝난 후 인터럽트가 발생하기 직전의 프로세스에게 cpu 제어권을 다시 넘김
- 인터럽트를 처리하는 중 인터럽트가 발생했을 때
    - 원칙적으로는 인터럽트 처리중에는 다른 인터럽트를 처리하지 않음
    - 인터럽트마다 중요도가 있어 상대적으로 중요한 인터럽트를 먼저 처리하게 됨

## 6. 시스템 콜

- 프로그램이 인터럽트 라인에 세팅함으로서 인터럽트를 발생시킴

## 7. 프로세스의 두 가지 실행 상태

- 사용자 모드에서의 실행 상태 (user mode running)
    - 프로세스가 프로세스의 주소 공간에서 함수를 실행시키는 경우
- 커널 모드에서의 실행 상태 (kernel mode running)
    - 프로세스가 커널의 시스템 콜 함수를 사용하는 경우
    - 실제 실행되는 코드는 운영체제 커널의 코드이지만 시스템 콜이 수행되는 동안에는 프로세스가 실행 상태(running state) 에 있다고 한다
    - cpu 의 제어권을 넘겨주긴 하지만 사실 커널이 프로세스의 일을 대행하고 있는 것
    - 프로그램 종료시에는 커널 모드로 진입하여 프로그램을 종료시킴